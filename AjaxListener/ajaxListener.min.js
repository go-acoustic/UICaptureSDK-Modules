/*!
 * Copyright (c) 2021 Acoustic, L.P. All rights reserved.
 *
 * NOTICE: This file contains material that is confidential and proprietary to
 * Acoustic, L.P. and/or other developers. No license is granted under any intellectual or
 * industrial property rights of Acoustic, L.P. except as may be provided in an agreement with
 * Acoustic, L.P. Any unauthorized copying or distribution of content from this file is
 * prohibited.
 *
 * README
 * https://github.com/acoustic-analytics/UICaptureSDK-Modules/blob/master/AjaxListener/README.md
 */
TLT.addModule("ajaxListener",function(c){var l={},h=false,j,p,A,k,u=c.utils;function q(D){var F,B,G,E=false,C=l.urlBlocklist;if(!D||!C){return E}for(F=0,B=C.length;!E&&F<B;F+=1){G=C[F];E=G.cRegex.test(D)}return E}function f(D,I,C){var F,B,G={},H=l.filters,E;if(!H||!H.length){return G}for(F=0,B=H.length,E=false;!E&&F<B;F+=1){G=H[F];E=true;if(G.url){E=G.url.cRegex.test(D)}if(E&&G.method){E=G.method.cRegex.test(I)}if(E&&G.status){E=G.status.cRegex.test(C)}}if(!E){G=null}return G}function o(F){var H={},D,B,G,C,E;F=F.split(/[\r\n]+/);for(D=0,B=F.length;D<B;D+=1){G=F[D].split(": ");C=G[0];E=u.rtrim(G[1]);if(C&&C.length){H[C]=E}}return H}function m(I,E){var H={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"XHR"}}},D,C=H.customEvent.data,B;if(!I){return}D=document.createElement("a");D.href=I.tListener.url;C.originalURL=D.host+(D.pathname[0]==="/"?"":"/")+D.pathname;C.requestURL=c.normalizeUrl?c.normalizeUrl(C.originalURL,3):C.originalURL;C.description="Full Ajax Monitor "+C.requestURL;C.method=I.tListener.method;C.status=I.status;C.statusText=I.statusText||"";C.async=I.tListener.async;C.ajaxResponseTime=I.tListener.end-I.tListener.start;C.locationHref=c.normalizeUrl(document.location.href,3);if(E.requestHeaders){C.requestHeaders=I.tListener.reqHeaders}if(E.requestData&&typeof I.tListener.reqData==="string"&&!I.tListener.isSystemXHR){try{C.request=JSON.parse(I.tListener.reqData)}catch(G){C.request=I.tListener.reqData}}if(E.responseHeaders){C.responseHeaders=o(I.getAllResponseHeaders())}if(E.responseData){if(typeof I.responseType==="undefined"){B=I.responseText}else{if(I.responseType===""||I.responseType==="text"){B=I.response}else{if(I.responseType==="json"){C.response=I.response}else{C.response=typeof I.response}}}if(B){try{C.response=JSON.parse(B)}catch(F){C.response=B}}if(I.responseType){C.responseType=I.responseType}}c.post(H)}function r(D){var F,E={},C=D.entries(),B=C.next();while(!B.done){F=B.value;E[F[0]]=F[1];B=C.next()}return E}function g(B){return r(B)}function b(B){var D=B;if(!B){return D}if(typeof B==="object"&&B.toString().indexOf("FormData")!==-1){D=r(B)}else{if(typeof B==="string"){try{D=JSON.parse(B)}catch(C){D=B}}}return D}function s(B,E,F){var G={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"fetch"}}},D,C=G.customEvent.data,H;D=document.createElement("a");D.href=B.url;C.originalURL=D.host+(D.pathname[0]==="/"?"":"/")+D.pathname;C.requestURL=c.normalizeUrl?c.normalizeUrl(C.originalURL,3):C.originalURL;C.description="Full Ajax Monitor "+C.requestURL;C.method=B.initData.method;C.status=E.status;C.statusText=E.statusText||"";C.async=true;C.ajaxResponseTime=B.end-B.start;C.responseType=E.type;C.locationHref=c.normalizeUrl(document.location.href,3);if(F.requestHeaders){if(B.initData.headers&&B.initData.headers.toString().indexOf("Headers")!==-1){C.requestHeaders=g(B.initData.headers)}else{C.requestHeaders=B.initData.headers||""}}if(F.requestData&&typeof B.body!=="undefined"&&!B.isSystemXHR){C.request=b(B.body)}if(F.responseHeaders){C.responseHeaders=g(E.headers)}if(F.responseData){H=E.headers.get("content-type");if(H&&H.indexOf("application/json")!==-1){E.clone().json().then(function(I){C.response=I;c.post(G)});return}if(H&&(H.indexOf("text")!==-1||H.indexOf("xml")!==-1)){E.clone().text().then(function(I){C.response=I;c.post(G)});return}C.response="Not logging unsupported response content: "+H}c.post(G)}function n(F){var D,C=F.tListener.url,G=F.tListener.method,B=F.status.toString(),E={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};D=f(C,G,B);if(D){if(D.log){E=D.log}m(F,E)}}function a(B,F){var E,D=B.url,H=B.initData.method,C=F.status.toString(),G={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};if(q(D)){return}E=f(D,H,C);if(E){if(E.log){G=E.log}s(B,F,G)}}function x(C){var D,B;if(!C||!C.target){return}D=C.target;B=D.readyState;if(B===4){D.removeEventListener("readystatechange",x);D.tListener.end=Date.now();n(D)}}function t(C){var B=C.setRequestHeader;C.setRequestHeader=function(G,E){var F=this,D=F.tListener;if(G&&G.length){D.reqHeaders[G]=E}return B.apply(F,arguments)}}function z(B){var C=B.send;B.send=function(E){var F=this,D=F.tListener;if(E){D.reqData=E}D.start=Date.now();return C.apply(F,arguments)}}function v(C){var D,B,E;B=TLT.getServiceConfig("queue");E=B.queues||[];for(D=0;D<E.length;D+=1){if(E[D].endpoint&&C.indexOf(E[D].endpoint)!==-1){return true}}return false}function w(E,B,C){var D=this;if(h&&!q(B)){D.addEventListener("readystatechange",x);D.tListener={method:E,url:B,async:(typeof C==="undefined")?true:!!C,reqHeaders:{},isSystemXHR:v(B)};t(D);z(D)}return j.apply(D,arguments)}function y(){if(XMLHttpRequest){j=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=w}}function i(){p=window.fetch;window.fetch=function(D,C){var B={},E;if(typeof D==="object"){B.initData=D;B.url=D.url;B.initData.clone().text().then(function(F){if(F.length>0){B.body=F}})}else{B.initData=C||{};B.url=D;if(C&&C.body){B.body=C.body}}B.isSystemXHR=v(B.url);B.start=Date.now();E=p.apply(this,arguments);return E.then(function(F){B.end=Date.now();a(B,F);return F})}}function d(B){if(B&&B.regex){B.cRegex=new RegExp(B.regex,B.flags)}}function e(D){var E,B,F,G=[],C=u.getValue(D,"skipSafetyCheck",false);if(D&&D.filters){G=D.filters}for(E=0,B=G.length;E<B;E+=1){F=G[E];u.forEach([F.url,F.method,F.status],d)}if(D&&D.urlBlocklist){u.forEach(D.urlBlocklist,d)}A=u.getValue(D,"xhrEnabled",true)&&window.XMLHttpRequest;if(A&&!C&&(XMLHttpRequest.toString().indexOf("[native code]")===-1||XMLHttpRequest.toString().indexOf("XMLHttpRequest")===-1)){A=false}k=u.getValue(D,"fetchEnabled",true)&&window.fetch;if(k&&!C&&window.fetch.toString().indexOf("[native code]")===-1){k=false}}return{init:function(){l=c.getConfig();e(l)},destroy:function(){h=false},onevent:function(B){switch(B.type){case"load":if(A){y()}if(k){i()}h=true;break;case"unload":h=false;break;default:break}},version:"1.3.0"}});
